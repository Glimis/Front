## 案例
1. biz项目
   - 首页图片相应过慢
   - 用户上传图片后 【超过500K】,引起断崖刷新
2. 智慧乡村
   - 移动端首屏加载,用户已经切换到底,背景图还没有刷新出来
。。。

#### 来源
原因只有一个,没有图片服务器 【穷】

#### 解决
薅百度,微博,简书,知乎的羊毛 【使用他们的图片加速】

将图片上传至大厂项目中后,直接引用即可 【全局追加`noreferrer`,使用 `NoCDN img` 进行上传】

## 介绍

本文不探讨如何薅羊毛  【薅羊毛是可耻的...图片服务器不贵的 orz】

用来介绍图片优化的相关知识与核心思路

### 图片加载
`非阻塞`的`http`加载

- 非阻塞
  不同于初次加载的css/js,图片加载并不影响浏览器之后的渲染与解析

  非阻塞的依据是`不相关`,即后续的htmp/css/js并不依赖图片的字节 【有依赖,使用onload回调兜底】

  根据`不相关`的特性产生的优化思路即单独的服务器/工程

  比如早期设计个人头像时,当用户删除时,业务上会删除图片  【这种依赖比较强,图片是单独的字段】

  或者,富文本依赖,沿用上述的思路,当删帖等操作的时候,业务上应该需要删除图片  【这种依赖比较弱,图片引用可能在富文本里】

  用`不相关`的思路考虑的话,图片是可以不用删除的  【薅羊毛的基础】

  当然`不相关`的设计是简单的,但用户无法彻底删除自己的私有图片 【可能会被告"侵犯隐私"】

- http
  1. 遵守tcp端口限制,通常统一域名6个  【早期神规范是2个-。-】
  2. 通过http无缝薅羊毛
  3. 跨域          【指是否可获取到字节,意义不大】

可以使用http加速的方法  【http1与http2 加速方式 有互斥的部分】

### 图片的大小
图片优化的核心是改变图片的大小 【传输速度属于http】

此处有以下相关概念

- rgb/hsl 表示颜色的结构/方法
这里最关心的是1个像素的大小

比如早期`16色/256色` 代表 一个像素最多可显示的颜色数量

通常的rgb叫`24位`,代表 一个颜色,需要24个Bit 【3字节】 

即一个颜色8位,1个字节【00 ~ FF】,故 一个像素 == 三个字节

图

- 分辨率
宽 高 各占多少像素 

假设 1000*1000 则有 1M个像素  ,算上`24位`像素的字节 可能有 3M

像素的多少,降低分辨率是提速的第一选择 【视频系】

图 - bmp 大小对比

- 格式/结构

格式 === 描述结构,不同的算法面向的也是不同的场景,此处指看常用


  1. bmp - Bitmap - 位图
    `bit`就是位,结构上就是数组,有一个算一个

    图

  2. gif - Graphics Interchange Format - 图形交互格式
    
    图形交互格式,说白了,就是动画/音乐,最高支持256种颜色    【动画一帧一图,理解一下】

    LZW算法 动态拓展字典  【录指纹算法-。-】

    图

    注:
      一种自动播放音频/视频的邪教就是使用gif

  3. png  -  Portable Network Graphics - 便携式网络图形
    说白了,就是logo

    LZ77算法  【lz家族】

  4. jpeg   - Joint Photographic Experts Group  - 联合图像专家组
    这个名字是开发者

    彩色 + 有损  【假设一张图每个像素都是一种不同的颜色,如何压缩? --》有损】


### 优化策略
1. 规范类别与用途
   再次强调压缩算法主要针对用途,故此处提供常用图片与格式
  bmp - 业务
  gif - 动画/音频
  png - logo/小图
  jpeg - 活动/宣传/彩色大图

2. 降低分辨率
  降低分辨率是减少体积最直接的方式

  针对小图,使用低分辨率,放大时,使用高分辨率

3. 有损 + 无损
  有损可以理解为毛玻璃,先用有损base64,在异步加载  【base64,反向压缩,但架不住有损压缩率高】

注:
  实现上,大部分优化操作是一致的,都是先小图,在原图

  区别可以是业务上,图可以缩放,降低分辨率最佳,图不能缩放,毛玻璃更优秀

  也可以是网络环境或设备环境   【img srcset属性】


4. 雪碧图 【http1】
  将图片合并,生成一张图,减少http链接数量

  注:
    http1,在传递少量数据时,传输效率极低,通讯2次【1.5 ~ 2.5 ,指周期】,交互数据1次,效率只有33%,合并会增大体积,但提高传输效率

5. [有损]压缩
  通常压缩都是有损的,无损只是删"注释"

  表示图片的数据结构不一样,所以不同的图片,也就有了不同的库


### 图片服务
url有两种意思,1.资源,2.服务

图片服务指根据参数动态提供资源,这里将提供图片的行为分类

说白了就是,低清  -> 通过事件 -> 高清 或者 通过事件 -> 低/高 清

这个事件,可以是网络环境的监听,媒体大小,点击操作 等,图片服务,就是无限的缩写图片之间调用的差异
